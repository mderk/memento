# Technical Specification: Claude AI Environment Plugin

**Version**: 2.0.0
**Date**: 2025-01-13
**Relates to**: [PRD.md](PRD.md)

## 1. Architecture Overview

### Plugin Structure

```
memento/           # PLUGIN ROOT
â”œâ”€â”€ .claude-plugin/
â”‚   â””â”€â”€ plugin.json              # Plugin manifest
â”œâ”€â”€ agents/                      # Plugin's own agents
â”‚   â””â”€â”€ environment-generator.md # Main generation agent
â”œâ”€â”€ commands/                    # Plugin's own commands
â”‚   â””â”€â”€ create-ai-environment.md # Main initialization command
â”œâ”€â”€ prompts/                     # Generation instructions (LLM-adapted)
â”‚   â”œâ”€â”€ SCHEMA.md               # Prompt file format spec
â”‚   â”œâ”€â”€ memory_bank/            # Prompts for Memory Bank docs
â”‚   â”‚   â”œâ”€â”€ *.md.prompt         # Core docs (5 files)
â”‚   â”‚   â”œâ”€â”€ guides/             # Guide prompts (10 files)
â”‚   â”‚   â”œâ”€â”€ workflows/          # Workflow prompts (11 files)
â”‚   â”‚   â””â”€â”€ patterns/           # Pattern prompts (2 files)
â”‚   â”œâ”€â”€ agents/                 # Prompts to generate agents in USER project
â”‚   â”‚   â”œâ”€â”€ code-reviewer.md.prompt
â”‚   â”‚   â”œâ”€â”€ test-runner.md.prompt
â”‚   â”‚   â””â”€â”€ design-reviewer.md.prompt
â”‚   â””â”€â”€ commands/               # Prompts to generate commands in USER project
â”‚       â”œâ”€â”€ prime.md.prompt
â”‚       â”œâ”€â”€ create-prd.md.prompt
â”‚       â”œâ”€â”€ create-spec.md.prompt
â”‚       â”œâ”€â”€ generate-tasks.md.prompt
â”‚       â”œâ”€â”€ process-tasks-list.md.prompt
â”‚       â””â”€â”€ code-review.md.prompt
â”œâ”€â”€ static/                      # Static content (copied as-is)
â”‚   â”œâ”€â”€ manifest.yaml           # File list with conditionals
â”‚   â””â”€â”€ memory_bank/            # Static docs for Memory Bank
â”‚       â”œâ”€â”€ guides/             # Universal guides
â”‚       â”œâ”€â”€ workflows/          # Universal workflows
â”‚       â””â”€â”€ patterns/           # Universal patterns
â””â”€â”€ docs/
    â”œâ”€â”€ README.md
    â”œâ”€â”€ PRD.md
    â”œâ”€â”€ SPECIFICATION.md (this file)
    â”œâ”€â”€ RESEARCH_REPORT.md
    â”œâ”€â”€ IMPLEMENTATION_PLAN.md
    â”œâ”€â”€ GETTING_STARTED.md
    â””â”€â”€ CUSTOMIZATION.md

---

# What gets GENERATED in user's project:
user-project/
â”œâ”€â”€ .claude/                     # Generated by plugin
â”‚   â”œâ”€â”€ agents/                  # Generated from prompts/agents/
â”‚   â”‚   â”œâ”€â”€ code-reviewer.md
â”‚   â”‚   â”œâ”€â”€ test-runner.md
â”‚   â”‚   â””â”€â”€ design-reviewer.md
â”‚   â””â”€â”€ commands/                # Generated from prompts/commands/
â”‚       â”œâ”€â”€ prime.md
â”‚       â”œâ”€â”€ create-prd.md
â”‚       â”œâ”€â”€ create-spec.md
â”‚       â”œâ”€â”€ generate-tasks.md
â”‚       â”œâ”€â”€ process-tasks-list.md
â”‚       â””â”€â”€ code-review.md
â”œâ”€â”€ .memory_bank/                # Generated from prompts/memory_bank/
â”‚   â”œâ”€â”€ README.md
â”‚   â”œâ”€â”€ product_brief.md
â”‚   â”œâ”€â”€ tech_stack.md
â”‚   â”œâ”€â”€ current_tasks.md
â”‚   â”œâ”€â”€ task-management-guide.md
â”‚   â”œâ”€â”€ guides/
â”‚   â”œâ”€â”€ workflows/
â”‚   â””â”€â”€ patterns/
â””â”€â”€ CLAUDE.md                    # AI assistant onboarding
```

### Architecture Principles

**Dual Content System:**

-   **Prompt files** (`.prompt`): LLM generates project-specific content from instructions
-   **Static files**: Content copied as-is to projects (no LLM modification)
-   Both support conditional logic based on project analysis

**Prompt-Based Generation:**

-   Uses `.prompt` files containing LLM generation instructions
-   Each prompt describes how to generate a specific file
-   LLM adapts content to detected project stack
-   No placeholders - fully project-specific content

**Static Content:**

-   Files in `static/` are copied without modification
-   `manifest.yaml` defines file list and conditional expressions
-   Ideal for universal processes, checklists, reference docs
-   Evaluated against `project-analysis.json` for conditional copying

**Two-Phase Process:**

-   **Phase 1 (Planning)**: Analyze, evaluate conditionals, create plan
-   **Phase 2 (Generation)**: Copy static files, then orchestrate prompt-based generation

**Context Efficiency:**

-   Each generation agent reads only 1 prompt (~200 lines)
-   Shared context via `project-analysis.json` (~50 lines)
-   Static files require zero LLM tokens (direct copy)

## 2. Component Specifications

### 2.1 Plugin Manifest

**File**: `.claude-plugin/plugin.json`

```json
{
    "name": "memento",
    "version": "1.0.0",
    "description": "AI development environment generator",
    "author": {
        "name": "Your Name",
        "email": "your.email@example.com"
    },
    "commands": "./commands",
    "agents": "./agents",
    "keywords": [
        "ai",
        "documentation",
        "workflow",
        "agents",
        "code-review",
        "memory-bank"
    ]
}
```

### 2.2 Environment Generator Agent

**File**: `agents/environment-generator.md` (plugin's agent)

```yaml
---
name: environment-generator
description: Generates complete AI development environment from prompt files
capabilities:
    - Detect project tech stack
    - Read and process .prompt files
    - Generate project-specific documentation
    - Create AI agents and slash commands
    - Handle conditional content based on stack
tools: [Bash, Glob, Grep, Read, Write, Edit]
model: sonnet
color: blue
---
```

**Behavior**:

1. **Analyze Project**: Scan for package.json, requirements.txt, go.mod, etc.
2. **Detect Stack**: Identify backend/frontend frameworks, databases, test frameworks
3. **Read Prompts**: Read all `.prompt` files from prompts/ directory
4. **Process by Priority**: Sort by priority field in YAML frontmatter
5. **Check Conditions**: Evaluate conditional expressions (e.g., "has_backend")
6. **Generate Content**: Use LLM to generate project-specific content from instructions
7. **Save Files**: Write to target_path specified in frontmatter
8. **Report Progress**: Notify user of generation progress

### 2.3 Prompt File Format

**File**: `prompts/SCHEMA.md`

Prompt files contain generation instructions for the LLM.

**Structure**:

````yaml
---
file: output-filename.md
target_path: .memory_bank/guides/
priority: 10
dependencies: ["file1.md", "file2.md"]
conditional: "has_backend"
---

# Generation Instructions for guides/output-filename.md

## Context
[What this file is for]

## Input Data
```json
{
  "project_name": "string",
  "has_backend": true|false,
  "backend_framework": "Django|FastAPI|..."
}
````

## Output Requirements

[Detailed instructions for content generation]

## Conditional Logic

[How to handle different project types]

````

**Key Fields**:
- `file`: Output filename
- `target_path`: Where to save in user's project
- `priority`: Generation order (lower = earlier)
- `dependencies`: Files that must exist first
- `conditional`: Natural language expression for when to generate

**Generated Files**:

| Category | Count | Examples |
|----------|-------|----------|
| Core Docs | 5 | CLAUDE.md, README.md, product_brief.md |
| Guides | 10 | architecture.md, backend.md, frontend.md |
| Workflows | 11 | feature-development.md, bug-fixing.md |
| Patterns | 2 | index.md, api-design.md |
| Agents | 3 | code-reviewer.md, test-runner.md, design-reviewer.md |
| Commands | 7 | prime.md, code-review.md, run-tests.md |

**Total**: 38 prompt files generating project-specific content

### 2.4 Main Command: /create-environment

**File**: `commands/create-environment.md`

```markdown
---
description: Initialize AI development environment with Memory Bank
argument-hint: [--auto]
---

# Create AI Environment

This command sets up a comprehensive AI development environment in your project.

## What it does

**Phase 1: Planning**
1. **Analyzes your project** - Detects technology stack automatically
2. **Scans prompt templates** - Finds all generation files (reads metadata only)
3. **Evaluates conditions** - Determines which files to generate for your stack
4. **Creates generation plan** - Shows what will be generated, waits for confirmation

**Phase 2: Generation** (after user confirms "Go")
1. **Orchestrates generation** - Launches one agent per file (prevents context overflow)
2. **Generates Memory Bank** - Creates comprehensive documentation structure
3. **Installs AI agents** - Adds code-reviewer, test-runner, design-reviewer
4. **Configures workflow commands** - Adds prime, code-review, run-tests, create-prd, etc.

## Usage

```bash
# Two-phase process with confirmation
/create-environment
# ... review generation-plan.md ...
Go  # User confirms to proceed
````

## Workflow

### Phase 1: Create Generation Plan

**Step 1: Launch Planning Agent**

Command launches a planning agent via Task tool to:

1. Analyze project structure
2. Detect technology stack
3. Scan all .prompt files (read only frontmatter)
4. Evaluate conditionals
5. Create generation plan

**Step 2: Save Project Analysis**

Agent creates `.memory_bank/project-analysis.json`:

```json
{
  "project_name": "string",
  "project_type": "web_app|api|...",
  "has_backend": true|false,
  "has_frontend": true|false,
  "backend_framework": "Django|FastAPI|...",
  "frontend_framework": "React|Vue|...",
  "is_monorepo": true|false,
  "backend_dir": "string",
  "frontend_dir": "string|null",
  ...
}
```

**Step 3: Create Generation Plan**

Agent creates `.memory_bank/generation-plan.md`:

```markdown
# AI Environment Generation Plan

## Project Analysis

-   Project Name: MyProject
-   Backend: Django 5.2
-   Frontend: React 19
-   Is Monorepo: true

## Files to Generate via Prompts (35 files)

**Note**: Additionally, 4 universal workflow files are copied from `static/` directory.

### Priority 1-10: Core Documentation (5 files)

-   [ ] **CLAUDE.md** â†’ `root/`
    -   Prompt: `prompts/memory_bank/CLAUDE.md.prompt`
-   [ ] **README.md** â†’ `.memory_bank/`
    -   Prompt: `prompts/memory_bank/README.md.prompt`
        [...]

## Skipped Files (3 files)

-   ~~mobile.md~~ - has_mobile=false
```

**Step 4: User Confirms**

Present plan to user and wait for "Go" confirmation.

### Phase 2: Orchestrated Generation

**Step 5: Generate Files One-by-One**

Command orchestrates generation by launching one agent per file:

```
For each file in generation-plan.md (in priority order):
  1. Check dependencies
  2. Launch agent via Task tool with:
     - Prompt file path
     - Project analysis path
     - Target output path
  3. Agent reads:
     - One .prompt file (~200 lines)
     - project-analysis.json (~50 lines)
  4. Agent generates file
  5. Command marks file as [x] in plan
  6. Report progress: "âœ“ Generated filename (5/35)" for prompts, "ðŸ“‹ Copied filename (static)" for static files
  7. Continue to next file
```

**Key Advantage:** Each agent has minimal context (~250 lines) instead of all 38 prompts (~7500 lines), preventing context overflow.

**Step 6: Report Results**

```
âœ… AI Environment created successfully!

Generated:
  - 28 documentation files (.memory_bank/)
  - 3 AI agents (.claude/agents/)
  - 7 workflow commands (.claude/commands/)
  - 1 onboarding guide (CLAUDE.md)

Review .memory_bank/generation-plan.md for details.

Next steps:
  1. Review generated docs in .memory_bank/README.md
  2. Customize product_brief.md with your product vision
  3. Try: /prime to load context
  4. Try: /code-review <files> to review code

Total files generated: 39
```

## Error Handling

**Phase 1 Failures (Planning):**

-   If project detection fails, report error and suggest manual config
-   If .prompt files not found, verify plugin installation
-   If frontmatter parsing fails, report which prompt file has invalid YAML

**Phase 2 Failures (Generation):**

-   If single file generation fails:
    -   Report which file failed
    -   Show generation-plan.md to see progress
    -   User can fix issue and resume from that file
-   If dependencies missing:
    -   Report missing dependency
    -   Skip file, continue with others
-   Each agent failure is isolated (doesn't affect other files)

**File Conflicts:**

-   If .memory_bank already exists:
    -   Warn user before Phase 2
    -   Allow user to cancel or continue (overwrites existing)
    -   Consider backing up existing files first

**Recovery:**

-   generation-plan.md shows [x] for completed files
-   User can resume by running Phase 2 again
-   Already completed files can be skipped (check [x] marks)

## Examples

See [GETTING_STARTED.md](../docs/GETTING_STARTED.md) for detailed examples.

````

## 3. Prompt-Based Generation System

### 3.1 How It Works

Instead of templates with placeholders, we use **generation prompts** that instruct the LLM to create project-specific content.

**Generation Process:**
1. Agent reads `.prompt` file with generation instructions
2. Agent reads `project-analysis.json` with project data
3. Agent generates content following instructions
4. Content is fully adapted to project (no placeholders remain)

**Example prompt file structure:**
```yaml
---
file: tech_stack.md
target_path: .memory_bank/
priority: 4
dependencies: []
conditional: null
---

# Generation Instructions for tech_stack.md

## Context
You are generating the tech stack documentation for {project_name}.

## Input Data
You have access to project-analysis.json with fields:
- backend_framework, frontend_framework, database, etc.

## Output Requirements
Generate markdown with:
- Backend section (if has_backend)
- Frontend section (if has_frontend)
- Database section (if has_database)
- Adapt all examples to actual stack

## Example
[Full example for Django + React project]
````

### 3.2 Project Context Injection

**No placeholder replacement** - LLM generates project-specific content directly.

**Available data** (from project-analysis.json):

-   `project_name`, `project_type`, `project_description`
-   `has_backend`, `has_frontend`, `has_database`
-   `backend_framework`, `frontend_framework`, `database`
-   `is_monorepo`, `backend_dir`, `frontend_dir`
-   `backend_test_framework`, `frontend_test_framework`
-   `dev_command`, `test_command`, `build_command`

**LLM adapts:**

-   Examples to match actual frameworks
-   Directory names to match actual structure
-   Commands to match actual package manager
-   Conditionally includes/excludes sections

### 3.3 Prompt Files Organization

**35 prompt files total:**

-   `prompts/memory_bank/*.prompt` (6 files) - Core documentation
-   `prompts/memory_bank/guides/*.prompt` (9 files) - Implementation guides
-   `prompts/memory_bank/workflows/*.prompt` (8 files) - Development workflows
-   `prompts/memory_bank/patterns/*.prompt` (2 files) - Design patterns
-   `prompts/agents/*.prompt` (3 files) - Agent definitions
-   `prompts/commands/*.prompt` (7 files) - Slash commands

**4 static files** (copied without LLM modification):

-   `static/memory_bank/workflows/*.md` (3 files) - Universal workflows
-   `static/memory_bank/guides/*.md` (1 file) - Universal checklists

**Total files in generated projects**: 39 (35 prompt-based + 4 static)

**Each prompt file contains:**

-   YAML frontmatter (metadata)
-   Generation instructions (context, requirements, examples)
-   Quality checklist
-   Common mistakes to avoid

See `prompts/SCHEMA.md` for full specification.

## 4. Data Flow

### Phase 1: Planning

```
User runs /create-environment
         â†“
Command launches planning agent via Task
         â†“
Agent analyzes project (detect frameworks)
         â†“
Agent creates .memory_bank/project-analysis.json
         â†“
Agent scans all .prompt files (reads frontmatter only)
         â†“
Agent evaluates conditionals per project
         â†“
Agent creates .memory_bank/generation-plan.md
         â†“
Command presents plan to user
         â†“
User reviews plan
         â†“
User confirms with "Go"
```

### Phase 2: Orchestrated Generation

```
Command reads generation-plan.md
         â†“
For each file in plan (sorted by priority):
  â”‚
  â”œâ”€â†’ Command checks dependencies
  â”‚
  â”œâ”€â†’ Command launches agent via Task
  â”‚       Agent reads ONE .prompt file
  â”‚       Agent reads project-analysis.json
  â”‚       Agent generates content
  â”‚       Agent writes to target_path
  â”‚
  â”œâ”€â†’ Command marks file [x] in plan
  â”‚
  â””â”€â†’ Command reports progress (N/35)
         â†“
All files generated
         â†“
Command reports final summary
```

**Key characteristics:**

-   Minimal context per agent (~250 lines vs ~7500)
-   Isolated agent failures (one file doesn't break others)
-   Transparent progress tracking (generation-plan.md)
-   Resumable (can continue from [x] marks)

## 5. Performance Characteristics

**Phase 1 (Planning):**

-   Project analysis: ~5-10 seconds
-   Scanning 38 .prompt frontmatters: ~2-3 seconds
-   Creating plan: ~1 second
-   **Total Phase 1**: ~10-15 seconds

**Phase 2 (Generation):**

-   Per-file generation: ~5-10 seconds each
-   35 prompt files Ã— ~7 seconds = ~250 seconds (~4 minutes)
-   4 static files Ã— instant copy = ~0 seconds
-   Total: ~4 minutes
-   Progress visible throughout (updates after each file)
-   **Total Phase 2**: ~4-5 minutes

**Context usage per agent:**

-   Planning agent: ~2000 lines (frontmatters + detection logic)
-   Generation agents: ~250 lines each (1 prompt + project-analysis.json)
-   **No context overflow risk**

**Scalability:**

-   Adding new prompt files: Linear cost (1 agent per file)
-   100 prompt files = ~10 minutes generation time
-   Each agent isolated (parallel execution possible in future)

## 6. Edge Cases

**Empty project directory:**

-   Planning agent reports: "Cannot detect technology stack"
-   User can manually create project-analysis.json

**Existing Memory Bank:**

-   Phase 2 warns before overwriting
-   User can backup or cancel
-   Resumable if interrupted (check [x] marks in plan)

**No config files detected:**

-   Planning agent uses defaults
-   User reviews plan before Phase 2
-   Can manually edit project-analysis.json

**Mixed tech stacks:**

-   Planning agent detects all frameworks
-   Conditional logic includes relevant sections
-   Example: Django + React generates both backend and frontend guides

**Non-standard structure:**

-   Planning agent does best-effort detection
-   User can edit project-analysis.json before Phase 2
-   Generated files may need manual adjustment

## 7. Error Recovery

**Phase 1 failures:**

-   Planning agent fails â†’ No files generated
-   Safe to retry (no side effects)

**Phase 2 failures:**

-   Single file fails â†’ Other files continue
-   generation-plan.md shows progress ([x] marks)
-   Can resume from last successful file
-   Each agent isolated (no cascading failures)

**Interruption handling:**

-   User cancels â†’ generation-plan.md preserved
-   Can resume by running Phase 2 again
-   Already generated files marked [x]
-   Command can skip completed files

## 8. Future Enhancements

**v1.1.0:**

-   Parallel agent execution for Phase 2 (reduce 4 minutes to ~1 minute)
-   `/sync-docs` command to update existing Memory Bank
-   `/update-tech-stack` command to regenerate after stack changes

**v1.2.0:**

-   Custom prompt directories (user-defined generation templates)
-   Team prompt sharing (shared .prompt repositories)
-   Incremental regeneration (only changed files)

**v2.0.0:**

-   Visual generation progress UI
-   IDE integrations (VSCode extension)
-   Prompt marketplace (community-contributed prompts)

---

**Implementation Status**: Architecture complete, ready for use
**Last Updated**: 2025-01-13
**Version**: 2.0.0 (Prompt-Based + Orchestrated Generation)
